<!DOCTYPE html>
<html lang="zh_cn">
  <head>
    {% include 'head.html' %}
    <script>
      var user_type = 0;
      function timestampToYMD(timestamp) {
        var date = new Date(timestamp * 1000);
        var year = date.getFullYear();
        var month = ("0" + (date.getMonth() + 1)).slice(-2);
        var day = ("0" + date.getDate()).slice(-2);
        return year + "-" + month + "-" + day;
      }
      var user_exit = (session_id) => {
        $.ajax({
          url: "/api/v1/user/logout",
          method: "POST",
          timeout: 0,
          headers: {
            "Content-Type": "application/json",
            "X-Session-ID": session_id,
          },
        }).done((response) => {});
      };

      var getUserTypeAndContinue = (keep_time) => {
        var session_id = $.cookie("session_id");
        if (session_id) {
          $.ajax({
            url: "/api/v1/session/verify",
            method: "GET",
            timeout: 0,
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": session_id,
            },
          }).done((response) => {
            if (response.success) {
              console.log(response);
              $.ajax({
                url: "/api/v1/user/info",
                method: "POST",
                timeout: 0,
                headers: {
                  "Content-Type": "application/json",
                },
                data: JSON.stringify({
                  uid: $.cookie("uid"),
                }),
              }).done((response) => {
                if (response.success) {
                  if (response.data.group == "default") {
                    user_type = 1;
                    if (keep_time > 30) {
                      $("#upload_warning")[0].innerText = "* 最多仅能保存 30 天";
                      return;
                    } else {
                      $("#upload_modal_second").modal("hide");
                      $("#upload_modal").modal("hide");
                      uploadFile(keep_time);
                    }
                  } else if (response.data.group == "operator") {
                    $("#upload_modal_second").modal("hide");
                    $("#upload_modal").modal("hide");
                    uploadFile(keep_time);
                  }
                }
              });
            } else {
              if (user_type == 0 && keep_time > 1) {
                $("#upload_warning")[0].innerText = "* 你尚未登录，最多仅能保存 1 天";
                return;
              }
              else {
                $("#upload_modal_second").modal("hide");
                $("#upload_modal").modal("hide");
                uploadFile(keep_time);
              }
            }
          });
        }
        else {
          if (user_type == 0 && keep_time > 1) {
            $("#upload_warning")[0].innerText = "* 你尚未登录，最多仅能保存 1 天";
            return;
          }
          else {
            $("#upload_modal_second").modal("hide");
            $("#upload_modal").modal("hide");
            uploadFile(keep_time);
          }
        }
      };

      var uploadFile = (keep_time) => {
        fileInput = document.getElementById("fileInput");
        file = fileInput.files[0];
        file_name = file.name;
        formData = new FormData();
        formData.append("fileInput", file);
        formData.append("keep_time", keep_time * 24 * 60 * 60);
        formData.append("receive_user", 0);
        fileInput.value = null;
        var headers = {};
        if ($.cookie("session_id") != undefined) {
          headers["X-Session-ID"] = $.cookie("session_id");
        }
        $.ajax({
          url: "/api/v1/files/upload",
          method: "POST",
          headers: headers,
          data: formData,
          processData: false,
          contentType: false,
        }).done((response) => {
          if (response.success) {
            code = response.data.code;
            $("#file_name_dispaly")[0].innerText = file_name;
            $(".code_display")[0].innerText = code;
            $("#upload_modal_second")
              .modal({
                blurring: true,
                observeChanges: true,
              })
              .modal("show");
          } else if (response.code == 401) {
            $.removeCookie("uid");
          } else {
            alert(response.data.message);
          }
        });
      };
      var downloadByCode = (code) => {
        $.ajax({
          url: "/api/v1/files/get",
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Session-ID": $.cookie("session_id"),
          },
          data: JSON.stringify({
            code: code,
          }),
        }).done((response) => {
          if (response.success) {
            $("#download_modal_by_code").modal("hide");
            $("#download_list_modal").modal("hide");
            $("#download_list_modal tbody").append(`
              <tr>
                <td data-label="文件名">${response.data.filemeta.filename}</td>
                <td data-label="上传时间">${timestampToYMD(response.data.filemeta.upload_time)}</td>
                <td data-label="取件码" style="color: rgb(66, 145, 246)"">${response.data.filemeta.code}</td>
                <td data-label="操作">
                  <button class="downloadbutton" onclick="downloadFileByClick('${response.data.task_uuid.toString()}')"><i class="download icon"></i></button>
                </td>
              </tr>
            `);
            $("#download_list_modal")
              .modal({
                blurring: true,
                observeChanges: true,
              })
              .modal("show");
          }
        });
      };
      var downloadFileByClick = (task_uuid) => {
        console.log("click");
        window.location.href = "/api/v1/files/download?task_uuid=" + task_uuid;
      }
      var downloadFileList = () => {
        $.ajax({
          url: "/api/v1/files/list",
          type: "POST",
          headers: {
            "X-Session-ID": "your_session_id",
          },
          success: function (data, status, xhr) {
            console.log(data);
          },
          error: function (xhr, status, error) {
            console.error("Error: " + status + " " + error);
          },
        }).done((response) => {
          if (response.success) {
          }
        });
      };
    </script>
  </head>
  <body>
    <div class="app">
      <div class="flex flex-col items-end w-full">
        <div class="ui icon top right pointing dropdown button">
          <i class="user circle icon"></i>
          <div class="menu">
            <div id="display_username" class="header hidden"></div>
            <div id="login_button" class="item">登录</div>
            <div id="exit_button" class="item">退出</div>
          </div>
        </div>
      </div>
      <div class="flex flex-col flex-grow justify-center items-center">
        <img
          class="w-1/3 md:w-1/5 mb-8"
          src="/static/favicon/favicon.png"
          alt="FileDock"
        />
        <input type="file" id="fileInput" style="opacity: 0" />
        <button
          id="upload_button"
          class="massive ui button blue w-1/2 md:w-2/5 text-xl"
        >
          上传
        </button>
        <button id="download_button" class="massive ui button w-1/2 md:w-2/5 text-xl">接收</button>
        <div id="upload_modal" class="ui modal mydimmer" style="width: 500px">
          <div class="header">
            <div class="flex items-center">
              <button
                id="upload_modal_close_button_first"
                class="close icon button"
              >
                <i class="close icon"></i>
              </button>
              <h3 class="ml-2">上传文件</h3>
            </div>
          </div>
          <div class="content">
            <div class="field">
              <div class="ui form">
                <div class="field">
                  <label>保存天数</label>
                  <input
                    id="keep_time_form"
                    type="text"
                    placeholder="1"
                    value="1"
                  />
                </div>
              </div>
              <div class="flex mt-2">
                <p id="upload_warning" class="mb-6" style="color: red;"></p>
              </div>
              <div class="flex justify-center mt-2">
                <button
                  id="upload_modal_button"
                  class="ui button blue w-1/2 md:w-1/5 text-xl"
                >
                  上传
                </button>
              </div>
            </div>
          </div>
        </div>
        <div id="upload_modal_second" class="ui modal square mydimmer">
          <div class="header">
            <button
              id="upload_modal_close_button_second"
              class="close icon button"
            >
              <i class="close icon"></i>
            </button>
          </div>
          <div class="content">
            <div class="flex flex-col items-center">
              <p class="text-xl font-bold mb-20">
                您的文件 <span id="file_name_dispaly"></span> 已成功上传
              </p>
              <p class="mb-6">您的取件码：</p>
              <div class="code_display font-bold mb-11">123456</div>
              <!-- <div class="flex justify-center">
                <a href="#" class="massive ui blue w-1/2 md:w-2/5 text-xl " onclick="copyCode()" style="animation: glowing 2s infinite;">
                  复制
                </a>
              </div> -->
              <p class="m-10">接收文件时请输入此取件码。</p>
              <p class="mb-1">
                由
                <a
                  href="/"
                  style="color: rgb(66, 145, 246)"
                  >FileDock</a
                >
                提供服务
              </p>
            </div>
          </div>
        </div>
        <div id="download_modal_by_code" class="ui modal mydimmer sorrow">
          <div class="header">
            <div class="flex items-center">
              <button
                id="download_modal_by_code_close_button"
                class="close icon button"
              >
                <i class="close icon"></i>
              </button>
              <h3 class="ml-2">取件码接收</h3>
            </div>
          </div>
          <div class="content">
            <div class="flex flex-col items-center">
              <p class="text-xl font-bold mb-16">
              </p>
              <div class="ui form mb-6 w-full">
                <div class="huge field">
                  <label>取件码</label>
                  <input type="text" placeholder="请输入取件码" class="flex content-between" />
                </div>
              </div>
              <div class="flex justify-center mt-16">
                <button id="download_by_code_button" class="ui button blue text-xl">
                  接收  
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="download_list_modal" class="ui modal mydimmer square">
        <div class="header">
          <div class="flex items-center">
            <button
              id="download_list_modal_close_button"
              class="close icon button"
            >
              <i class="close icon"></i>
            </button>
            <h3 id="download_list_modal_head" class="ml-2">文件列表</h3>
          </div>
        </div>
        <div class="content">
          <table id="download_list" class="ui celled striped table">
            <thead>
              <tr>
                <th>文件名</th>
                <th>上传时间</th>
                <th>取件码</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
      <div class="flex flex-col items-end w-full">
        {% include 'footer.html' %}
      </div>
    </div>
    <script>
      $("#login_button")[0].addEventListener("click", () => {
        window.location.href = "/login";
      });
      $("#exit_button")[0].addEventListener("click", () => {
        user_exit($.cookie(""));
        $.removeCookie("uid");
        $.removeCookie("session_id");
        window.location.href = "/";
      });
    </script>
    <script>
      $("#download_list_modal")
        .modal({
          blurring: true,
          observeChanges: true,
        })
        .modal("show");
      $("#upload_button")[0].addEventListener("click", () => {
        $("#fileInput").click();
      });
      $("#fileInput").on("input", () => {
        $("#upload_modal")
          .modal({
            blurring: true,
            observeChanges: true,
          })
          .modal("show");
      });
      $("#upload_modal_button")[0].addEventListener("click", () => {
        keep_time = $("#keep_time_form")[0].value;
        if (Number.isInteger(parseInt(keep_time)) && parseInt(keep_time) > 0) {
          getUserTypeAndContinue(keep_time);
        } else {
          $("#upload_warning")[0].innerText = "* 非法输入";          
        }
      });
      $("#upload_modal_close_button_first")[0].addEventListener("click", () => {
        $("#upload_modal").modal("hide");
        $("#upload_modal_second").modal("hide");
      });
      $("#upload_modal_close_button_second")[0].addEventListener(
        "click",
        () => {
          $("#upload_modal").modal("hide");
          $("#upload_modal_second").modal("hide");
        }
      );
      $("#download_button")[0].addEventListener("click", () => {
        $("#download_modal_by_code")
          .modal({
            blurring: true,
            observeChanges: true,
          })
          .modal("show");
      });
      $("#download_modal_by_code_close_button")[0].addEventListener("click", () => {
        $("#download_modal_by_code").modal("hide");
        $("#download_list_modal").modal("hide");
      });
      $("#download_list_modal_close_button")[0].addEventListener("click", () => {
        $("#download_modal_by_code").modal("hide");
        $("#download_list_modal").modal("hide");
      });
      $("#download_by_code_button")[0].addEventListener("click", () => {
        code = $("#download_modal_by_code input")[0].value;
        downloadByCode(code);
      });
    </script>
    <script>
      $(".ui.dropdown").dropdown();

      var display_username = () => {
        disname_obj = $("#display_username")[0];
        disname_obj.classList.remove("hidden");
        disname_obj.classList.add("font-bold");
        $.ajax({
          url: "/api/v1/user/info",
          method: "POST",
          timeout: 0,
          headers: {
            "Content-Type": "application/json",
          },
          data: JSON.stringify({
            uid: $.cookie("uid"),
          }),
        }).done((response) => {
          if (response.success) {
            $("#display_username")[0].innerText = response.data.username;
          }
        });
      };
      session_id = $.cookie("session_id");
      if (session_id) {
        $.ajax({
          url: "/api/v1/session/verify",
          method: "GET",
          timeout: 0,
          headers: {
            "Content-Type": "application/json",
            "X-Session-ID": session_id,
          },
        }).done((response) => {
          if (response.success) {
            $("#login_button")[0].classList.add("hidden");
            if(response.data.group == "default" ) user_type = 1;
            else if(response.data.group == "operator") user_type = -1;
            display_username();
          }
        });
      }
      var copyCode = () => {
        var codeDisplay = document.querySelector(".code_display");
        var code = codeDisplay.innerText;
        navigator.clipboard.writeText(code);
      };
    </script>
  </body>
</html>
